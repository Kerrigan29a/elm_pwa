<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <title>Dice Roller</title>
    <link rel="icon" href="favicon.ico" sizes="any">
    <link rel="apple-touch-icon" href="apple-touch-icon.png">
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="normalize.css">
    <link rel="stylesheet" href="magick.css">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="version-warning.css">
    <script src="main.js"></script>
</head>

<body>
</body>

<script type="text/javascript">
    // Register service worker to control making site work offline
    window.addEventListener('load', () => {
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker
                .register('service-worker.js')
                .then(() => { console.log('[Service Worker] Registered'); })
                .catch((err) => { console.warn('[Service Worker] Error: ' + err); })
        }
    });

    // Load Elm app
    var STORAGE_NAME = 'dice-roller-v1';

    function initializeApp() {
        if (typeof Elm === 'undefined' || typeof Elm.Main === 'undefined') {
            console.error('Elm application failed to load. main.js may be missing or invalid.');
            document.body.innerHTML = '<div style="color: #d9534f; padding: 20px; background: #f2dede; border: 1px solid #ebccd1; border-radius: 4px;"><h2>Error Loading Application</h2><p>The application failed to initialize. Please refresh the page.</p><p style="font-size: 12px; color: #666;">If the problem persists, try clearing your browser cache.</p></div>';
            return;
        }

        try {
            var storedData = localStorage.getItem(STORAGE_NAME);
            var flags = storedData ? JSON.parse(storedData) : null;

            var app = Elm.Main.init({
                flags: flags
            });

            // Only subscribe to ports if they exist
            if (app.ports && app.ports.setStorage) {
                app.ports.setStorage.subscribe(function (state) {
                    localStorage.setItem(STORAGE_NAME, JSON.stringify(state));
                });
            }
            
            if (app.ports && app.ports.clearStorage) {
                app.ports.clearStorage.subscribe(function () {
                    localStorage.removeItem(STORAGE_NAME);
                });
            }

            if (app.ports && app.ports.reloadApp) {
                app.ports.reloadApp.subscribe(async function () {
                    try {
                        // Clear local storage for this app
                        localStorage.removeItem(STORAGE_NAME);

                        // Unregister service workers to avoid stale cache
                        if (navigator.serviceWorker) {
                            const regs = await navigator.serviceWorker.getRegistrations();
                            await Promise.all(regs.map((r) => r.unregister()));
                        }

                        // Clear caches created by the service worker
                        if (window.caches && caches.keys) {
                            const keys = await caches.keys();
                            await Promise.all(keys.map((k) => caches.delete(k)));
                        }
                    } catch (err) {
                        console.warn('[Reload] Failed to clear service worker caches', err);
                    } finally {
                        // Hard reload
                        window.location.reload(true);
                    }
                });
            }

            if (app.ports && app.ports.copyToClipboard) {
                app.ports.copyToClipboard.subscribe(function (relativeUrl) {
                    try {
                        var fullUrl = window.location.origin + window.location.pathname + relativeUrl;

                        if (navigator.clipboard && navigator.clipboard.writeText) {
                            navigator.clipboard.writeText(fullUrl).catch(function (err) {
                                console.warn('[Clipboard] Failed to write using navigator.clipboard', err);
                            });
                        } else {
                            var textarea = document.createElement('textarea');
                            textarea.value = fullUrl;
                            document.body.appendChild(textarea);
                            textarea.select();
                            document.execCommand('copy');
                            document.body.removeChild(textarea);
                        }
                    } catch (err) {
                        console.warn('[Clipboard] Copy failed', err);
                    }
                });
            }
        } catch (err) {
            console.error('Failed to initialize Elm app:', err);
            document.body.innerHTML = '<div style="color: #d9534f; padding: 20px; background: #f2dede; border: 1px solid #ebccd1; border-radius: 4px;"><h2>Initialization Error</h2><p>' + err.message + '</p><p style="font-size: 12px; color: #666;"><strong>Details:</strong> ' + err.stack + '</p></div>';
        }
    }

    // Wait for DOM to be ready before initializing
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeApp);
    } else {
        initializeApp();
    }
</script>

</html>
